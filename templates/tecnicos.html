{% extends "base.html" %}

{% block title %}T√©cnicos{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6">üë∑ Gest√£o de T√©cnicos</h1>
        <p class="text-muted">Gerencie a equipe de t√©cnicos da empresa</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoTecnicoModal">
            <i class="fas fa-plus"></i> Novo T√©cnico
        </button>
        <button class="btn btn-success ms-2" onclick="exportarTecnicos()">
            <i class="fas fa-file-export"></i> Exportar Lista
        </button>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Buscar t√©cnico..." id="searchTecnicos" onkeyup="filtrarTecnicos()">
            <select class="form-select" style="max-width: 180px;" id="filtroStatus" onchange="filtrarTecnicos()">
                <option value="">Todos os status</option>
                <option value="Ativo">‚úÖ Ativo</option>
                <option value="Inativo">‚ö™ Inativo</option>
                <option value="F√©rias">üå¥ F√©rias</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" title="Buscar">
                <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline-danger" type="button" onclick="limparFiltros()" title="Limpar Filtros">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>

<!-- Cards de T√©cnicos -->
<div class="row" id="listaTecnicos">
    {% for tecnico in tecnicos %}
    <div class="col-md-6 col-lg-4 mb-4 tecnico-card" data-nome="{{ tecnico.nome|lower }}" data-status="{{ tecnico.status }}">
        <div class="card h-100 shadow-sm">
            <div class="card-header {% if tecnico.status == 'Ativo' %}bg-success{% elif tecnico.status == 'F√©rias' %}bg-warning{% else %}bg-secondary{% endif %} text-white">
                <h6 class="mb-0">
                    <i class="fas fa-user-cog"></i> {{ tecnico.nome }}
                    <span class="badge bg-light text-dark float-end">{{ tecnico.status }}</span>
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong><i class="fas fa-id-card text-primary"></i> CPF:</strong><br>
                    <span class="text-muted">{{ tecnico.cpf or 'N√£o informado' }}</span>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-phone text-success"></i> Telefone:</strong><br>
                    <span class="text-muted">{{ tecnico.telefone or 'N√£o informado' }}</span>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-envelope text-info"></i> Email:</strong><br>
                    <span class="text-muted">{{ tecnico.email or 'N√£o informado' }}</span>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-wrench text-warning"></i> Especialidade:</strong><br>
                    <span class="badge bg-primary">{{ tecnico.especialidade or 'Geral' }}</span>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-calendar text-secondary"></i> Data Admiss√£o:</strong><br>
                    <span class="text-muted">{{ tecnico.data_admissao or 'N√£o informada' }}</span>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary btn-detalhes" data-id="{{ tecnico.id }}" title="Ver Detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success btn-whatsapp" data-tel="{{ tecnico.telefone or '' }}" title="WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning btn-editar" data-id="{{ tecnico.id }}" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-excluir" data-id="{{ tecnico.id }}" data-nome="{{ tecnico.nome }}" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-user-cog fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-2">Nenhum t√©cnico cadastrado ainda.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoTecnicoModal">
                    <i class="fas fa-plus"></i> Cadastrar Primeiro T√©cnico
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Estat√≠sticas -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h5>Total de T√©cnicos</h5>
                <h3>{{ tecnicos|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-user-check fa-2x mb-2"></i>
                <h5>Ativos</h5>
                <h3>
                    {% set ns = namespace(count=0) %}
                    {% for tecnico in tecnicos %}
                        {% if tecnico.status == 'Ativo' %}
                            {% set ns.count = ns.count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ ns.count }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-umbrella-beach fa-2x mb-2"></i>
                <h5>De F√©rias</h5>
                <h3>
                    {% set ns = namespace(count=0) %}
                    {% for tecnico in tecnicos %}
                        {% if tecnico.status == 'F√©rias' %}
                            {% set ns.count = ns.count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ ns.count }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-user-times fa-2x mb-2"></i>
                <h5>Inativos</h5>
                <h3>
                    {% set ns = namespace(count=0) %}
                    {% for tecnico in tecnicos %}
                        {% if tecnico.status == 'Inativo' %}
                            {% set ns.count = ns.count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ ns.count }}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo T√©cnico -->
<div class="modal fade" id="novoTecnicoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Novo T√©cnico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novoTecnicoForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" name="nome" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" name="cpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" name="telefone" placeholder="(11) 99999-8888">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Especialidade *</label>
                            <select class="form-select" name="especialidade" required>
                                <option value="">Selecione a especialidade</option>
                                <option value="Mec√¢nica Pesada">Mec√¢nica Pesada</option>
                                <option value="Mec√¢nica Geral">Mec√¢nica Geral</option>
                                <option value="El√©trica Automotiva">El√©trica Automotiva</option>
                                <option value="Hidr√°ulica">Hidr√°ulica</option>
                                <option value="Funilaria e Pintura">Funilaria e Pintura</option>
                                <option value="Ar Condicionado">Ar Condicionado</option>
                                <option value="Alinhamento e Balanceamento">Alinhamento e Balanceamento</option>
                                <option value="Inje√ß√£o Eletr√¥nica">Inje√ß√£o Eletr√¥nica</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de Admiss√£o</label>
                            <input type="date" class="form-control" name="data_admissao">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="Ativo" selected>Ativo</option>
                            <option value="F√©rias">F√©rias</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarNovoTecnico()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar T√©cnico -->
<div class="modal fade" id="editarTecnicoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Editar T√©cnico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editarTecnicoForm">
                    <input type="hidden" id="edit-id">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="edit-nome" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="edit-cpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="edit-telefone" placeholder="(11) 99999-8888">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Especialidade *</label>
                            <select class="form-select" id="edit-especialidade" required>
                                <option value="">Selecione a especialidade</option>
                                <option value="Mec√¢nica Pesada">Mec√¢nica Pesada</option>
                                <option value="Mec√¢nica Geral">Mec√¢nica Geral</option>
                                <option value="El√©trica Automotiva">El√©trica Automotiva</option>
                                <option value="Hidr√°ulica">Hidr√°ulica</option>
                                <option value="Funilaria e Pintura">Funilaria e Pintura</option>
                                <option value="Ar Condicionado">Ar Condicionado</option>
                                <option value="Alinhamento e Balanceamento">Alinhamento e Balanceamento</option>
                                <option value="Inje√ß√£o Eletr√¥nica">Inje√ß√£o Eletr√¥nica</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de Admiss√£o</label>
                            <input type="date" class="form-control" id="edit-data-admissao">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-status">
                            <option value="Ativo">Ativo</option>
                            <option value="F√©rias">F√©rias</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarEdicaoTecnico()">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes do T√©cnico -->
<div class="modal fade" id="detalhesTecnicoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-cog"></i> Perfil Completo do T√©cnico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Cabe√ßalho do Perfil -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-user-tie text-white fs-3"></i>
                            </div>
                            <div>
                                <h3 id="detalhe-nome" class="mb-1 text-primary"></h3>
                                <p class="text-muted mb-0" id="detalhe-especialidade-header"></p>
                            </div>
                            <div class="ms-auto">
                                <span id="detalhe-status-badge"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes Pessoais -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-id-card text-primary"></i> Informa√ß√µes Pessoais</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-item mb-3">
                                    <label class="form-label text-muted mb-1">CPF</label>
                                    <div class="fw-bold" id="detalhe-cpf"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item mb-3">
                                    <label class="form-label text-muted mb-1">Telefone</label>
                                    <div class="fw-bold" id="detalhe-telefone"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item mb-3">
                                    <label class="form-label text-muted mb-1">Email</label>
                                    <div class="fw-bold" id="detalhe-email"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes Profissionais -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-briefcase text-primary"></i> Informa√ß√µes Profissionais</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <label class="form-label text-muted mb-1">Especialidade</label>
                                    <div class="fw-bold" id="detalhe-especialidade"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <label class="form-label text-muted mb-1">Data de Admiss√£o</label>
                                    <div class="fw-bold" id="detalhe-data-admissao"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico de Manuten√ß√µes -->
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-history text-primary"></i> Hist√≥rico de Manuten√ß√µes</h6>
                        <small class="text-muted" id="total-manutencoes"></small>
                    </div>
                    <div class="card-body">
                        <div id="historico-manutencoes">
                            <div class="d-flex justify-content-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="btn btn-success" id="btn-whatsapp-modal">
                    <i class="fab fa-whatsapp"></i> Contatar via WhatsApp
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Salvar novo t√©cnico
function salvarNovoTecnico() {
    const form = document.getElementById('novoTecnicoForm');
    const formData = new FormData(form);
    
    const data = {
        nome: formData.get('nome'),
        cpf: formData.get('cpf'),
        telefone: formData.get('telefone'),
        email: formData.get('email'),
        especialidade: formData.get('especialidade'),
        data_admissao: formData.get('data_admissao'),
        status: formData.get('status')
    };
    
    fetch('/api/tecnico', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao salvar t√©cnico');
    });
}

// Editar t√©cnico
function editarTecnico(id) {
    // Buscar dados do t√©cnico
    fetch(`/api/tecnico/${id}`)
        .then(response => response.json())
        .then(tecnico => {
            document.getElementById('edit-id').value = tecnico.id;
            document.getElementById('edit-nome').value = tecnico.nome;
            document.getElementById('edit-cpf').value = tecnico.cpf || '';
            document.getElementById('edit-telefone').value = tecnico.telefone || '';
            document.getElementById('edit-email').value = tecnico.email || '';
            document.getElementById('edit-especialidade').value = tecnico.especialidade || '';
            document.getElementById('edit-data-admissao').value = tecnico.data_admissao || '';
            document.getElementById('edit-status').value = tecnico.status || 'Ativo';
            
            const modal = new bootstrap.Modal(document.getElementById('editarTecnicoModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao carregar dados do t√©cnico');
        });
}

// Salvar edi√ß√£o
function salvarEdicaoTecnico() {
    const id = document.getElementById('edit-id').value;
    
    const data = {
        nome: document.getElementById('edit-nome').value,
        cpf: document.getElementById('edit-cpf').value,
        telefone: document.getElementById('edit-telefone').value,
        email: document.getElementById('edit-email').value,
        especialidade: document.getElementById('edit-especialidade').value,
        data_admissao: document.getElementById('edit-data-admissao').value,
        status: document.getElementById('edit-status').value
    };
    
    fetch(`/api/tecnico/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao atualizar t√©cnico');
    });
}

// Confirmar exclus√£o
function confirmarExclusao(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o t√©cnico "${nome}"?`)) {
        fetch(`/api/tecnico/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                location.reload();
            } else {
                alert('‚ùå Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao excluir t√©cnico');
        });
    }
}

// Ver detalhes do t√©cnico
function verDetalhesTecnico(id) {
    fetch(`/api/tecnico/${id}`)
        .then(response => response.json())
        .then(tecnico => {
            // Preenche informa√ß√µes b√°sicas
            document.getElementById('detalhe-nome').textContent = tecnico.nome || 'Nome n√£o informado';
            document.getElementById('detalhe-especialidade-header').textContent = tecnico.especialidade || 'Especialidade n√£o informada';
            
            // Informa√ß√µes pessoais
            document.getElementById('detalhe-cpf').innerHTML = tecnico.cpf ? 
                `<i class="fas fa-id-card me-1"></i>${formatarCPF(tecnico.cpf)}` : 
                '<span class="text-muted"><i class="fas fa-minus"></i> N√£o informado</span>';
                
            document.getElementById('detalhe-telefone').innerHTML = tecnico.telefone ? 
                `<i class="fas fa-phone me-1"></i>${formatarTelefone(tecnico.telefone)}` : 
                '<span class="text-muted"><i class="fas fa-minus"></i> N√£o informado</span>';
                
            document.getElementById('detalhe-email').innerHTML = tecnico.email ? 
                `<i class="fas fa-envelope me-1"></i>${tecnico.email}` : 
                '<span class="text-muted"><i class="fas fa-minus"></i> N√£o informado</span>';
            
            // Informa√ß√µes profissionais
            document.getElementById('detalhe-especialidade').innerHTML = tecnico.especialidade ? 
                `<span class="badge bg-primary">${tecnico.especialidade}</span>` : 
                '<span class="text-muted">N√£o informada</span>';
                
            document.getElementById('detalhe-data-admissao').innerHTML = tecnico.data_admissao ? 
                `<i class="fas fa-calendar me-1"></i>${formatarData(tecnico.data_admissao)}` : 
                '<span class="text-muted"><i class="fas fa-minus"></i> N√£o informada</span>';
            
            // Status com badge colorido e √≠cone
            const statusBadge = document.getElementById('detalhe-status-badge');
            if (tecnico.status === 'Ativo') {
                statusBadge.innerHTML = '<span class="badge bg-success fs-6"><i class="fas fa-check-circle"></i> Ativo</span>';
            } else if (tecnico.status === 'F√©rias') {
                statusBadge.innerHTML = '<span class="badge bg-warning fs-6"><i class="fas fa-umbrella-beach"></i> F√©rias</span>';
            } else {
                statusBadge.innerHTML = '<span class="badge bg-danger fs-6"><i class="fas fa-times-circle"></i> Inativo</span>';
            }

            // Configurar bot√£o WhatsApp
            const btnWhatsApp = document.getElementById('btn-whatsapp-modal');
            if (tecnico.telefone) {
                btnWhatsApp.onclick = () => contatarWhatsApp(tecnico.telefone);
                btnWhatsApp.style.display = 'inline-block';
            } else {
                btnWhatsApp.style.display = 'none';
            }
            
            // Busca hist√≥rico de manuten√ß√µes
            fetch(`/api/tecnico/${id}/historico`)
                .then(response => response.json())
                .then(historico => {
                    const divHistorico = document.getElementById('historico-manutencoes');
                    const totalManutencoes = document.getElementById('total-manutencoes');
                    
                    totalManutencoes.textContent = `${historico.length} manuten√ß√£o(√µes) registrada(s)`;
                    
                    if (historico.length === 0) {
                        divHistorico.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-wrench fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Nenhuma manuten√ß√£o registrada</h6>
                                <p class="text-muted mb-0">Este t√©cnico ainda n√£o possui hist√≥rico de manuten√ß√µes.</p>
                            </div>
                        `;
                    } else {
                        let html = '<div class="table-responsive">';
                        html += '<table class="table table-hover align-middle">';
                        html += `<thead class="table-light">
                            <tr>
                                <th><i class="fas fa-calendar"></i> Data</th>
                                <th><i class="fas fa-car"></i> Ve√≠culo</th>
                                <th><i class="fas fa-wrench"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Status</th>
                                <th><i class="fas fa-dollar-sign"></i> {{ 'Valor' if is_servico else 'Custo' }}</th>
                            </tr>
                        </thead><tbody>`;
                        
                        historico.forEach(m => {
                            let statusBadge = '';
                            let statusIcon = '';
                            
                            switch(m.status) {
                                case 'Conclu√≠da':
                                    statusBadge = '<span class="badge bg-success"><i class="fas fa-check"></i> Conclu√≠da</span>';
                                    break;
                                case 'Em Andamento':
                                    statusBadge = '<span class="badge bg-primary"><i class="fas fa-cog fa-spin"></i> Em Andamento</span>';
                                    break;
                                case 'Agendada':
                                    statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock"></i> Agendada</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="badge bg-secondary">-</span>';
                            }
                            
                            const custo = m.custo ? `R$ ${parseFloat(m.custo).toFixed(2).replace('.', ',')}` : '-';
                            const data = m.data ? formatarData(m.data) : '-';
                            
                            html += `<tr>
                                <td>${data}</td>
                                <td><strong>${m.veiculo || '-'}</strong></td>
                                <td><span class="badge bg-info">${m.tipo || '-'}</span></td>
                                <td>${statusBadge}</td>
                                <td><strong class="text-success">${custo}</strong></td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                        divHistorico.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar hist√≥rico:', error);
                    document.getElementById('historico-manutencoes').innerHTML = 
                        `<div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Erro ao carregar hist√≥rico de manuten√ß√µes.
                        </div>`;
                });
            
            // Abre o modal
            const modal = new bootstrap.Modal(document.getElementById('detalhesTecnicoModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            alert('‚ùå Erro ao carregar detalhes do t√©cnico');
        });
}

// Fun√ß√µes auxiliares de formata√ß√£o
function formatarCPF(cpf) {
    if (!cpf) return '';
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

function formatarTelefone(telefone) {
    if (!telefone) return '';
    const numbers = telefone.replace(/\D/g, '');
    if (numbers.length === 11) {
        return numbers.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (numbers.length === 10) {
        return numbers.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    return telefone;
}

function formatarData(data) {
    if (!data) return '';
    const date = new Date(data + 'T00:00:00');
    return date.toLocaleDateString('pt-BR');
}

// Contatar t√©cnico via WhatsApp
function contatarWhatsApp(telefone) {
    if (telefone && telefone !== 'N√£o informado') {
        // Remove caracteres n√£o num√©ricos
        const numeroLimpo = telefone.replace(/\D/g, '');
        
        // Mensagem padr√£o
        const mensagem = encodeURIComponent('Ol√°! Entrando em contato pelo sistema de Gest√£o de Frota.');
        
        // Abre WhatsApp Web
        window.open(`https://wa.me/55${numeroLimpo}?text=${mensagem}`, '_blank');
    } else {
        alert('ÔøΩ Telefone n√£o cadastrado');
    }
}

// Filtrar t√©cnicos
function filtrarTecnicos() {
    const searchText = document.getElementById('searchTecnicos').value.toLowerCase();
    const filtroStatus = document.getElementById('filtroStatus').value;
    const cards = document.querySelectorAll('.tecnico-card');
    
    let contadorVisiveis = 0;
    
    cards.forEach(card => {
        const nome = card.getAttribute('data-nome');
        const status = card.getAttribute('data-status');
        
        const matchSearch = nome.includes(searchText);
        const matchStatus = !filtroStatus || status === filtroStatus;
        
        if (matchSearch && matchStatus) {
            card.style.display = 'block';
            contadorVisiveis++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Feedback visual no select quando filtrado
    const selectElement = document.getElementById('filtroStatus');
    if (filtroStatus) {
        selectElement.style.backgroundColor = '#e3f2fd';
        selectElement.style.fontWeight = 'bold';
    } else {
        selectElement.style.backgroundColor = '';
        selectElement.style.fontWeight = '';
    }
}

// Limpar todos os filtros
function limparFiltros() {
    document.getElementById('searchTecnicos').value = '';
    document.getElementById('filtroStatus').value = '';
    filtrarTecnicos();
}

// Exportar lista de t√©cnicos
function exportarTecnicos() {
    alert('üìÑ Funcionalidade de exporta√ß√£o em desenvolvimento');
}

// Delegated click handlers for buttons that use data- attributes (avoids inline JS with template braces)
document.addEventListener('click', function(event) {
    const btn = event.target.closest('button');
    if (!btn) return;

    if (btn.classList.contains('btn-detalhes')) {
        const id = btn.getAttribute('data-id');
        if (id) verDetalhesTecnico(id);
    } else if (btn.classList.contains('btn-whatsapp')) {
        const tel = btn.getAttribute('data-tel') || '';
        contatarWhatsApp(tel);
    } else if (btn.classList.contains('btn-editar')) {
        const id = btn.getAttribute('data-id');
        if (id) editarTecnico(id);
    } else if (btn.classList.contains('btn-excluir')) {
        const id = btn.getAttribute('data-id');
        const nome = btn.getAttribute('data-nome') || '';
        if (id) confirmarExclusao(id, nome);
    }
});
</script>
{% endblock %}
