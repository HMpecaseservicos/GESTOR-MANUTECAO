{% extends "base.html" %}

{% block title %}Relatórios{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6">
            <i class="fas fa-chart-bar me-2"></i>Relatórios e Análises
        </h1>
        <p class="text-muted">
            {% if is_servico %}
            Análise de faturamento e performance comercial
            {% else %}
            Controle de custos e manutenções da frota
            {% endif %}
        </p>
    </div>
</div>

<!-- Filtros de Período -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="fas fa-filter"></i> Filtros de Período
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Data Inicial</label>
                <input type="date" class="form-control" id="dataInicial">
            </div>
            <div class="col-md-4">
                <label class="form-label">Data Final</label>
                <input type="date" class="form-control" id="dataFinal">
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button class="btn btn-primary flex-grow-1" onclick="carregarRelatorios()">
                    <i class="fas fa-search"></i> Gerar Relatório
                </button>
                <button class="btn btn-outline-secondary" onclick="limparFiltros()" title="Limpar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resumo Financeiro Dinâmico -->
<div class="row mb-4" id="resumoFinanceiro">
    {% if is_servico %}
    <!-- Cards SERVICO -->
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <h6>Faturamento Total</h6>
                <h4 id="totalValor">R$ --</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <i class="fas fa-receipt fa-2x mb-2"></i>
                <h6>Ticket Médio</h6>
                <h4 id="ticketMedio">R$ --</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                <h6>Serviços Realizados</h6>
                <h4 id="totalQuantidade">--</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h6>Clientes Atendidos</h6>
                <h4 id="totalClientes">--</h4>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Cards FROTA -->
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                <h6>Despesas Total</h6>
                <h4 id="totalValor">R$ --</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h6>Custo Médio</h6>
                <h4 id="custoMedio">R$ --</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-wrench fa-2x mb-2"></i>
                <h6>Manutenções Realizadas</h6>
                <h4 id="totalQuantidade">--</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary">
            <div class="card-body text-center">
                <i class="fas fa-car fa-2x mb-2"></i>
                <h6>Veículos Atendidos</h6>
                <h4 id="totalVeiculos">--</h4>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tabelas de Análise -->
<div class="row mb-4">
    <!-- Lista Detalhada -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header {% if is_servico %}bg-success{% else %}bg-primary{% endif %} text-white">
                <h6 class="mb-0">
                    <i class="fas fa-list"></i> 
                    {% if is_servico %}Top Clientes por Faturamento{% else %}Top Veículos por Custo{% endif %}
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                {% if is_servico %}
                                <th>Cliente</th>
                                <th>Serviços</th>
                                <th class="text-end">Faturamento</th>
                                {% else %}
                                <th>Placa</th>
                                <th>Modelo</th>
                                <th>Manutenções</th>
                                <th class="text-end">Custo Total</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="tabelaRanking">
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-search me-2"></i>Clique em "Gerar Relatório" para carregar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Exportação -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-download"></i> Exportar Relatórios</h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Exporte os dados do período selecionado:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="exportarPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Relatório Completo (PDF)
                    </button>
                    <button class="btn btn-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel me-2"></i>Planilha Excel (.xlsx)
                    </button>
                    <button class="btn btn-info" onclick="exportarCSV()">
                        <i class="fas fa-file-csv me-2"></i>Dados Brutos (CSV)
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportarResumo()">
                        <i class="fas fa-chart-pie me-2"></i>Resumo Executivo (PDF)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Info do Período -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-1"></i> Período Atual</h6>
                <p class="mb-0" id="infoPeriodo">Selecione as datas e clique em "Gerar Relatório"</p>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Registros -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    {% if is_servico %}Serviços Realizados{% else %}Manutenções Realizadas{% endif %}
                </h6>
                <span class="badge bg-light text-dark" id="badgeTotal">0 registros</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Data</th>
                                <th>Placa</th>
                                {% if is_servico %}<th>Cliente</th>{% endif %}
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th class="text-end">{% if is_servico %}Valor{% else %}Custo{% endif %}</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaRegistros">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-search me-2"></i>Selecione o período e clique em "Gerar Relatório"
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const IS_SERVICO = {{ 'true' if is_servico else 'false' }};

// Formatar moeda
function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    }).format(valor);
}

// Carregar relatórios
async function carregarRelatorios() {
    const dataInicial = document.getElementById('dataInicial').value;
    const dataFinal = document.getElementById('dataFinal').value;
    
    // Atualizar info do período
    const periodoInfo = dataInicial && dataFinal 
        ? `${dataInicial} até ${dataFinal}`
        : dataInicial 
        ? `A partir de ${dataInicial}`
        : dataFinal 
        ? `Até ${dataFinal}`
        : 'Todos os registros';
    document.getElementById('infoPeriodo').textContent = periodoInfo;
    
    // Construir URL com filtros
    let params = [];
    if (dataInicial) params.push(`data_inicio=${dataInicial}`);
    if (dataFinal) params.push(`data_fim=${dataFinal}`);
    const queryString = params.length > 0 ? '?' + params.join('&') : '';
    
    try {
        // Carregar relatório financeiro
        const respFinanceiro = await fetch(`/api/relatorios/financeiro${queryString}`);
        const dadosFinanceiro = await respFinanceiro.json();
        
        if (dadosFinanceiro.success) {
            atualizarCardsFinanceiros(dadosFinanceiro);
            atualizarTabelaRanking(dadosFinanceiro);
        }
        
        // Carregar lista de manutenções
        const respManutencoes = await fetch(`/api/relatorios/manutencoes${queryString}`);
        const dadosManutencoes = await respManutencoes.json();
        
        if (dadosManutencoes.success) {
            atualizarTabelaRegistros(dadosManutencoes.registros);
            document.getElementById('badgeTotal').textContent = `${dadosManutencoes.total_registros} registros`;
        }
        
    } catch (error) {
        console.error('Erro ao carregar relatórios:', error);
        alert('Erro ao carregar relatórios. Tente novamente.');
    }
}

// Atualizar cards financeiros
function atualizarCardsFinanceiros(dados) {
    if (IS_SERVICO) {
        document.getElementById('totalValor').textContent = formatarMoeda(dados.faturamento_total);
        document.getElementById('ticketMedio').textContent = formatarMoeda(dados.ticket_medio);
        document.getElementById('totalQuantidade').textContent = dados.qtd_servicos;
        document.getElementById('totalClientes').textContent = dados.lista_por_cliente?.length || 0;
    } else {
        document.getElementById('totalValor').textContent = formatarMoeda(dados.despesas_total);
        const custoMedio = dados.qtd_manutencoes > 0 ? dados.despesas_total / dados.qtd_manutencoes : 0;
        document.getElementById('custoMedio').textContent = formatarMoeda(custoMedio);
        document.getElementById('totalQuantidade').textContent = dados.qtd_manutencoes;
        document.getElementById('totalVeiculos').textContent = dados.lista_por_veiculo?.length || 0;
    }
}

// Atualizar tabela de ranking
function atualizarTabelaRanking(dados) {
    const tbody = document.getElementById('tabelaRanking');
    
    if (IS_SERVICO) {
        const lista = dados.lista_por_cliente || [];
        if (lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Nenhum cliente encontrado</td></tr>';
            return;
        }
        
        tbody.innerHTML = lista.slice(0, 10).map(item => `
            <tr>
                <td><strong>${item.cliente_nome}</strong></td>
                <td><span class="badge bg-info">${item.qtd_servicos}</span></td>
                <td class="text-end text-success fw-bold">${formatarMoeda(item.total_faturado)}</td>
            </tr>
        `).join('');
    } else {
        const lista = dados.lista_por_veiculo || [];
        if (lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Nenhum veículo encontrado</td></tr>';
            return;
        }
        
        tbody.innerHTML = lista.slice(0, 10).map(item => `
            <tr>
                <td><strong>${item.placa}</strong></td>
                <td>${item.modelo || '-'}</td>
                <td><span class="badge bg-warning">${item.qtd_manutencoes}</span></td>
                <td class="text-end text-danger fw-bold">${formatarMoeda(item.total_gasto)}</td>
            </tr>
        `).join('');
    }
}

// Atualizar tabela de registros
function atualizarTabelaRegistros(registros) {
    const tbody = document.getElementById('tabelaRegistros');
    
    if (!registros || registros.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">Nenhum registro encontrado</td></tr>`;
        return;
    }
    
    tbody.innerHTML = registros.map(reg => {
        const statusClass = getStatusClass(reg.status);
        return `
            <tr>
                <td>${reg.data || '-'}</td>
                <td><strong>${reg.placa}</strong></td>
                ${IS_SERVICO ? `<td>${reg.cliente_nome || '-'}</td>` : ''}
                <td><span class="badge bg-secondary">${reg.tipo || '-'}</span></td>
                <td>${(reg.descricao || '-').substring(0, 40)}${(reg.descricao?.length > 40) ? '...' : ''}</td>
                <td class="text-end fw-bold ${IS_SERVICO ? 'text-success' : 'text-danger'}">${formatarMoeda(reg.valor || 0)}</td>
                <td><span class="badge ${statusClass}">${reg.status || '-'}</span></td>
            </tr>
        `;
    }).join('');
}

// Obter classe de cor para status
function getStatusClass(status) {
    const statusMap = {
        'FINALIZADO': 'bg-success',
        'FATURADO': 'bg-success',
        'Concluída': 'bg-success',
        'EM_EXECUCAO': 'bg-primary',
        'Em Andamento': 'bg-primary',
        'APROVADO': 'bg-info',
        'ORCAMENTO': 'bg-warning',
        'Agendada': 'bg-warning',
        'RASCUNHO': 'bg-secondary'
    };
    return statusMap[status] || 'bg-secondary';
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('dataInicial').value = '';
    document.getElementById('dataFinal').value = '';
    document.getElementById('infoPeriodo').textContent = 'Selecione as datas e clique em "Gerar Relatório"';
}

// Funções de exportação
function getFilterParams() {
    const dataInicial = document.getElementById('dataInicial').value;
    const dataFinal = document.getElementById('dataFinal').value;
    
    const params = [];
    if (dataInicial) params.push('data_inicial=' + dataInicial);
    if (dataFinal) params.push('data_final=' + dataFinal);
    
    return params.length > 0 ? '?' + params.join('&') : '';
}

function exportarPDF() {
    window.location.href = '/exportar/pdf-completo' + getFilterParams();
}

function exportarExcel() {
    window.location.href = '/exportar/excel' + getFilterParams();
}

function exportarCSV() {
    window.location.href = '/exportar/csv' + getFilterParams();
}

function exportarResumo() {
    window.location.href = '/exportar/pdf' + getFilterParams();
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Definir datas padrão (último mês)
    const hoje = new Date();
    const mesPassado = new Date(hoje);
    mesPassado.setMonth(mesPassado.getMonth() - 1);
    
    document.getElementById('dataFinal').value = hoje.toISOString().split('T')[0];
    document.getElementById('dataInicial').value = mesPassado.toISOString().split('T')[0];
    
    // Carregar relatórios automaticamente
    carregarRelatorios();
});
</script>
{% endblock %}