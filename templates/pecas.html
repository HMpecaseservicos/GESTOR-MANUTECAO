{% extends "base.html" %}

{% block title %}Pe√ßas{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6">Gest√£o de Pe√ßas</h1>
        <p class="text-muted">Controle de estoque e pe√ßas para manuten√ß√£o</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaPecaModal">
            <i class="fas fa-plus"></i> Nova Pe√ßa
        </button>
        <button class="btn btn-warning ms-2" onclick="filtrarEstoqueBaixo()" id="btnEstoqueBaixo">
            <i class="fas fa-exclamation-triangle"></i> Estoque Baixo
        </button>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Buscar por nome ou c√≥digo..." id="searchPecas">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-cogs"></i> Cat√°logo de Pe√ßas</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome</th>
                        <th>Compatibilidade</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                        <th>Fornecedor</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for peca in pecas %}
                    <tr>
                        <td>
                            <strong class="text-primary">{{ peca[2] }}</strong>
                        </td>
                        <td>
                            <strong>{{ peca[1] }}</strong>
                        </td>
                        <td>
                            <small class="text-muted">{{ peca[3] }}</small>
                        </td>
                        <td>
                            <span class="text-success">R$ {{ "%.2f"|format(peca[4]) }}</span>
                        </td>
                        <td>
                            {% if peca[6] == 0 %}
                                <span class="badge bg-danger">{{ peca[6] }} un.</span>
                            {% elif peca[6] < 6 %}
                                <span class="badge bg-warning">{{ peca[6] }} un.</span>
                            {% else %}
                                <span class="badge bg-success">{{ peca[6] }} un.</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ peca[7] }}</small>
                        </td>
                        <td>
                            {% if peca[6] == 0 %}
                                <span class="badge bg-danger">Sem Estoque</span>
                            {% elif peca[6] < 6 %}
                                <span class="badge bg-warning">Estoque Baixo</span>
                            {% else %}
                                <span class="badge bg-success">Dispon√≠vel</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary btn-detalhes" title="Ver Detalhes" 
                                        data-peca-id="{{ peca[0] }}"
                                        data-peca-codigo="{{ peca[2] }}"
                                        data-peca-nome="{{ peca[1] }}"
                                        data-peca-compatibilidade="{{ peca[3] }}"
                                        data-peca-preco="{{ peca[4] }}"
                                        data-peca-estoque="{{ peca[6] }}"
                                        data-peca-fornecedor="{{ peca[7] }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning btn-editar" title="Editar"
                                        data-peca-id="{{ peca[0] }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if peca[6] < 6 %}
                                <button class="btn btn-sm btn-outline-success btn-solicitar" 
                                        title="Solicitar ao Fornecedor via WhatsApp"
                                        data-peca-codigo="{{ peca[2] }}"
                                        data-peca-nome="{{ peca[1] }}"
                                        data-peca-estoque="{{ peca[6] }}"
                                        data-peca-preco="{{ peca[4] }}"
                                        data-fornecedor-nome="{{ peca[7] }}"
                                        data-fornecedor-telefone="{{ peca[8] if peca[8] else '' }}"
                                        data-fornecedor-email="{{ peca[9] if peca[9] else '' }}">
                                    <i class="fab fa-whatsapp"></i> Solicitar
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" title="Estoque OK" disabled>
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger btn-excluir" title="Excluir"
                                        data-peca-id="{{ peca[0] }}" data-peca-nome="{{ peca[1] }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Estat√≠sticas de Estoque -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <i class="fas fa-cogs fa-2x mb-2"></i>
                <h5>Total de Pe√ßas</h5>
                <h3>{{ pecas|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h5>Dispon√≠veis</h5>
                <h3>
                    {% set count = namespace(value=0) %}
                    {% for peca in pecas %}
                        {% if peca[6] >= 6 %}
                            {% set count.value = count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ count.value }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h5>Estoque Baixo</h5>
                <h3>
                    {% set count = namespace(value=0) %}
                    {% for peca in pecas %}
                        {% if peca[6] > 0 and peca[6] < 6 %}
                            {% set count.value = count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ count.value }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h5>Sem Estoque</h5>
                <h3>
                    {% set count = namespace(value=0) %}
                    {% for peca in pecas %}
                        {% if peca[6] == 0 %}
                            {% set count.value = count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ count.value }}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Pe√ßa -->
<div class="modal fade" id="novaPecaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Nova Pe√ßa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novaPecaForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome da Pe√ßa</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">C√≥digo</label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ve√≠culo Compat√≠vel</label>
                        <input type="text" class="form-control" id="veiculo_compativel" name="veiculo_compativel" 
                               placeholder="Ex: Volvo FH Series, Mercedes Actros...">
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pre√ßo</label>
                            <input type="number" class="form-control" id="preco" name="preco" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantidade Inicial</label>
                            <input type="number" class="form-control" id="quantidade_estoque" name="quantidade_estoque" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fornecedor</label>
                            <select class="form-select" id="fornecedor" name="fornecedor_id" required>
                                <option value="">Selecione o fornecedor</option>
                                {% for fornecedor in fornecedores %}
                                <option value="{{ fornecedor['id'] if fornecedor is mapping else fornecedor[0] }}">{{ fornecedor['nome'] if fornecedor is mapping else fornecedor[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="2" 
                                  placeholder="Informa√ß√µes adicionais sobre a pe√ßa..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarPeca()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes da Pe√ßa -->
<div class="modal fade" id="detalhesPecaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-info-circle"></i> Detalhes da Pe√ßa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-barcode"></i> Identifica√ß√£o</h6>
                                <hr>
                                <div class="row mb-2">
                                    <div class="col-5"><strong>C√≥digo:</strong></div>
                                    <div class="col-7"><span class="badge bg-primary" id="detalhe-codigo">-</span></div>
                                </div>
                                <div class="row">
                                    <div class="col-5"><strong>Nome:</strong></div>
                                    <div class="col-7" id="detalhe-nome">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body">
                                <h6 class="text-success"><i class="fas fa-dollar-sign"></i> Valores</h6>
                                <hr>
                                <div class="row mb-2">
                                    <div class="col-5"><strong>Pre√ßo Unit.:</strong></div>
                                    <div class="col-7"><span class="text-success fs-5" id="detalhe-preco">-</span></div>
                                </div>
                                <div class="row">
                                    <div class="col-5"><strong>Estoque:</strong></div>
                                    <div class="col-7"><span id="detalhe-estoque-badge">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="text-warning"><i class="fas fa-car"></i> Compatibilidade</h6>
                                <hr>
                                <p id="detalhe-compatibilidade" class="mb-0">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body">
                                <h6 class="text-info"><i class="fas fa-truck"></i> Fornecedor</h6>
                                <hr>
                                <p id="detalhe-fornecedor" class="mb-0">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Pe√ßa -->
<div class="modal fade" id="editarPecaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Pe√ßa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editarPecaForm">
                    <input type="hidden" id="edit-peca-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome da Pe√ßa *</label>
                            <input type="text" class="form-control" id="edit-nome" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">C√≥digo *</label>
                            <input type="text" class="form-control" id="edit-codigo" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ve√≠culo Compat√≠vel</label>
                            <input type="text" class="form-control" id="edit-veiculo">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pre√ßo (R$) *</label>
                            <input type="number" step="0.01" class="form-control" id="edit-preco" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantidade em Estoque *</label>
                            <input type="number" class="form-control" id="edit-estoque" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fornecedor *</label>
                            <select class="form-select" id="edit-fornecedor" required>
                                <option value="">Selecione...</option>
                                {% for fornecedor in fornecedores %}
                                <option value="{{ fornecedor[0] }}">{{ fornecedor[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="edit-descricao" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarEdicao()">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Estoque -->
<div class="modal fade" id="ajustarEstoqueModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-boxes"></i> Ajustar Estoque da Pe√ßa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="estoque-peca-id">
                
                <!-- Informa√ß√µes da Pe√ßa -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Pe√ßa Selecionada</h6>
                    <strong id="estoque-peca-nome"></strong>
                </div>
                
                <!-- Estoque Atual -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="text-primary">üì¶ Estoque Atual</h6>
                                <h2 class="text-primary"><strong id="estoque-atual">0</strong> un.</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-success">üìà Novo Estoque</h6>
                                <h2 class="text-success"><strong id="preview-novo-estoque">0</strong> un.</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campo de Ajuste -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-edit"></i> Ajustar Quantidade em Estoque:
                    </label>
                    <div class="input-group">
                        <button class="btn btn-outline-danger" type="button" onclick="decrementarEstoque()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control text-center fs-4" id="nova-quantidade" 
                               min="0" required onchange="atualizarPreview()" oninput="atualizarPreview()">
                        <button class="btn btn-outline-success" type="button" onclick="incrementarEstoque()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <small class="text-muted">
                        üí° Use este campo para ajustar o estoque ap√≥s entrada/sa√≠da de pe√ßas
                    </small>
                </div>
                
                <!-- Atalhos R√°pidos -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Atalhos R√°pidos:</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(-10)">
                            -10
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(-5)">
                            -5
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(-1)">
                            -1
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="zerarEstoque()">
                            Zerar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(1)">
                            +1
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(5)">
                            +5
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="ajustarRapido(10)">
                            +10
                        </button>
                    </div>
                </div>
                
                <!-- Dica -->
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-lightbulb"></i> <strong>Dica:</strong> 
                    Este ajuste substitui o valor atual do estoque. Para adicionar ou remover, 
                    use os bot√µes +/- ou os atalhos r√°pidos.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-info" onclick="salvarEstoque()">
                    <i class="fas fa-save"></i> Atualizar Estoque
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclus√£o -->
<div class="modal fade" id="confirmarExclusaoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash"></i> Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="excluir-peca-id">
                <p>Tem certeza que deseja excluir a pe√ßa:</p>
                <p><strong id="excluir-peca-nome"></strong></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta a√ß√£o n√£o pode ser desfeita!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusao()">
                    <i class="fas fa-trash"></i> Excluir Definitivamente
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para carregar dados da pe√ßa para edi√ß√£o
function editarPeca(pecaId) {
    console.log('Editando pe√ßa ID:', pecaId);
    
    fetch(`/pecas/get/${pecaId}`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            if (data.success) {
                const peca = data.peca;
                document.getElementById('edit-peca-id').value = peca.id;
                document.getElementById('edit-nome').value = peca.nome;
                document.getElementById('edit-codigo').value = peca.codigo;
                document.getElementById('edit-veiculo').value = peca.veiculo_compativel || '';
                document.getElementById('edit-preco').value = peca.preco;
                document.getElementById('edit-estoque').value = peca.quantidade_estoque;
                document.getElementById('edit-fornecedor').value = peca.fornecedor_id;
                document.getElementById('edit-descricao').value = peca.descricao || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editarPecaModal'));
                modal.show();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro ao carregar dados da pe√ßa: ' + error.message);
            console.error('Erro completo:', error);
        });
}

// Fun√ß√£o para salvar edi√ß√£o
function salvarEdicao() {
    console.log('Salvando edi√ß√£o...');
    
    const formData = new FormData();
    formData.append('nome', document.getElementById('edit-nome').value);
    formData.append('codigo', document.getElementById('edit-codigo').value);
    formData.append('veiculo_compativel', document.getElementById('edit-veiculo').value);
    formData.append('preco', document.getElementById('edit-preco').value);
    formData.append('quantidade_estoque', document.getElementById('edit-estoque').value);
    formData.append('fornecedor_id', document.getElementById('edit-fornecedor').value);
    formData.append('descricao', document.getElementById('edit-descricao').value);
    
    const pecaId = document.getElementById('edit-peca-id').value;
    console.log('ID da pe√ßa:', pecaId);
    
    // Validar campos obrigat√≥rios
    if (!document.getElementById('edit-nome').value || 
        !document.getElementById('edit-codigo').value || 
        !document.getElementById('edit-preco').value || 
        !document.getElementById('edit-fornecedor').value) {
        alert('Por favor, preencha todos os campos obrigat√≥rios!');
        return;
    }
    
    // Obter CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    fetch(`/pecas/edit/${pecaId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Resposta do servidor:', data);
        if (data.success) {
            alert('Pe√ßa atualizada com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro ao salvar altera√ß√µes: ' + error.message);
        console.error('Erro completo:', error);
    });
}

// Fun√ß√£o para ajustar estoque
function ajustarEstoque(pecaId, pecaNome, estoqueAtual) {
    document.getElementById('estoque-peca-id').value = pecaId;
    document.getElementById('estoque-peca-nome').textContent = pecaNome;
    document.getElementById('estoque-atual').textContent = estoqueAtual;
    document.getElementById('nova-quantidade').value = estoqueAtual;
    document.getElementById('preview-novo-estoque').textContent = estoqueAtual;
    
    const modal = new bootstrap.Modal(document.getElementById('ajustarEstoqueModal'));
    modal.show();
}

// Atualizar preview do novo estoque
function atualizarPreview() {
    const novaQtd = parseInt(document.getElementById('nova-quantidade').value) || 0;
    document.getElementById('preview-novo-estoque').textContent = novaQtd;
}

// Incrementar estoque
function incrementarEstoque() {
    const input = document.getElementById('nova-quantidade');
    input.value = parseInt(input.value || 0) + 1;
    atualizarPreview();
}

// Decrementar estoque
function decrementarEstoque() {
    const input = document.getElementById('nova-quantidade');
    const novoValor = parseInt(input.value || 0) - 1;
    input.value = novoValor >= 0 ? novoValor : 0;
    atualizarPreview();
}

// Ajuste r√°pido (adicionar ou remover)
function ajustarRapido(valor) {
    const input = document.getElementById('nova-quantidade');
    const novoValor = parseInt(input.value || 0) + valor;
    input.value = novoValor >= 0 ? novoValor : 0;
    atualizarPreview();
}

// Zerar estoque
function zerarEstoque() {
    if (confirm('Tem certeza que deseja zerar o estoque desta pe√ßa?')) {
        document.getElementById('nova-quantidade').value = 0;
        atualizarPreview();
    }
}

// Fun√ß√£o para salvar novo estoque
function salvarEstoque() {
    const novaQtd = document.getElementById('nova-quantidade').value;
    const estoqueAtual = parseInt(document.getElementById('estoque-atual').textContent);
    const diferenca = parseInt(novaQtd) - estoqueAtual;
    
    let mensagem = `Confirmar ajuste de estoque?\n\n`;
    mensagem += `Estoque atual: ${estoqueAtual} un.\n`;
    mensagem += `Novo estoque: ${novaQtd} un.\n`;
    mensagem += `Diferen√ßa: ${diferenca > 0 ? '+' : ''}${diferenca} un.`;
    
    if (!confirm(mensagem)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('quantidade', novaQtd);
    
    const pecaId = document.getElementById('estoque-peca-id').value;
    
    fetch(`/pecas/estoque/${pecaId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Estoque atualizado com sucesso!');
            location.reload();
        } else {
            alert('‚ùå Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao atualizar estoque');
        console.error(error);
    });
}

// Fun√ß√£o para confirmar exclus√£o
function excluirPeca(pecaId, pecaNome) {
    document.getElementById('excluir-peca-id').value = pecaId;
    document.getElementById('excluir-peca-nome').textContent = pecaNome;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmarExclusaoModal'));
    modal.show();
}

// Fun√ß√£o para executar exclus√£o
function confirmarExclusao() {
    const pecaId = document.getElementById('excluir-peca-id').value;
    
    fetch(`/pecas/delete/${pecaId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Pe√ßa exclu√≠da com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro ao excluir pe√ßa');
        console.error(error);
    });
}

// Fun√ß√£o para salvar nova pe√ßa
function salvarPeca() {
    // Valida√ß√£o dos campos obrigat√≥rios
    const nome = document.getElementById('nome').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    const preco = document.getElementById('preco').value.trim();
    const quantidade = document.getElementById('quantidade_estoque').value.trim();
    const fornecedor = document.getElementById('fornecedor').value;
    
    if (!nome || !codigo || !preco || !quantidade || !fornecedor) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    const formData = new FormData();
    formData.append('nome', nome);
    formData.append('codigo', codigo);
    formData.append('veiculo_compativel', document.getElementById('veiculo_compativel').value.trim());
    formData.append('preco', preco);
    formData.append('quantidade_estoque', quantidade);
    formData.append('fornecedor_id', fornecedor);
    // N√£o enviando descricao pois o backend n√£o aceita
    
    fetch('/pecas/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Pe√ßa adicionada com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro ao salvar pe√ßa');
        console.error(error);
    });
}

// Fun√ß√£o para solicitar pe√ßa ao fornecedor via WhatsApp
function solicitarPecaWhatsApp(codigo, nome, estoque, preco, fornecedorNome, fornecedorTelefone, fornecedorEmail) {
    // Validar se h√° telefone
    if (!fornecedorTelefone) {
        alert('O fornecedor ' + fornecedorNome + ' nao tem telefone cadastrado!\n\nPor favor, cadastre o telefone antes de enviar a solicitacao.');
        return;
    }
    
    // Validar estoque e definir urg√™ncia
    const estoqueNum = parseInt(estoque);
    let urgencia = '';
    let quantidadeSugerida = 20;
    
    if (estoqueNum === 0) {
        urgencia = '*URGENTE - SEM ESTOQUE*';
        quantidadeSugerida = 10;
    } else if (estoqueNum <= 2) {
        urgencia = '*URGENTE - CRITICO*';
        quantidadeSugerida = 5;
    } else if (estoqueNum <= 5) {
        urgencia = 'Estoque Baixo';
        quantidadeSugerida = 2;
    } else {
        urgencia = 'Reposicao Programada';
        quantidadeSugerida = 5;
    }
    
    // Confirmar a√ß√£o
    if (!confirm('Deseja enviar solicitacao de compra para ' + fornecedorNome + ' via WhatsApp?\n\nPeca: ' + nome + '\nEstoque atual: ' + estoque + ' unidades')) {
        return;
    }
    
    // Obter data atual
    const hoje = new Date();
    const dataFormatada = hoje.toLocaleDateString('pt-BR');
    
    // Montar mensagem profissional
    const mensagem = `*SOLICITACAO DE COMPRA*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${urgencia}

 *DADOS DA PE√áA*
> Codigo: ${codigo}
> Nome: ${nome}
> Preco Ultimo: R$ ${parseFloat(preco).toFixed(2)}

*SITUACAO DO ESTOQUE*
> Estoque Atual: ${estoque} unidades
> Quantidade Solicitada: ${quantidadeSugerida} unidades

*INFORMACOES*
Data da Solicitacao: ${dataFormatada}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Por favor, confirme:
- Disponibilidade
- Preco atual
- Prazo de entrega

_Aguardo retorno._

_Departamento de Compra_`;

    // Limpar telefone (remover caracteres n√£o num√©ricos)
    const telefoneNumerico = fornecedorTelefone.replace(/\D/g, '');
    
    // Adicionar c√≥digo do pa√≠s se necess√°rio (Brasil = 55)
    const telefoneCompleto = telefoneNumerico.length === 11 ? '55' + telefoneNumerico : telefoneNumerico;
    
    // Abrir WhatsApp em nova aba
    const url = `https://wa.me/${telefoneCompleto}?text=${encodeURIComponent(mensagem)}`;
    window.open(url, '_blank');
    
    console.log('Solicitacao enviada para:', fornecedorNome, '- Tel:', telefoneCompleto);
}


// Delegated click handlers for buttons that use data-attributes rather than inline onclick
document.addEventListener('click', function (e) {
    const solicitarBtn = e.target.closest('.btn-solicitar');
    if (solicitarBtn) {
        const codigo = solicitarBtn.dataset.pecaCodigo;
        const nome = solicitarBtn.dataset.pecaNome;
        const estoque = solicitarBtn.dataset.pecaEstoque;
        const preco = solicitarBtn.dataset.pecaPreco;
        const fornecedorNome = solicitarBtn.dataset.fornecedorNome;
        const fornecedorTelefone = solicitarBtn.dataset.fornecedorTelefone;
        const fornecedorEmail = solicitarBtn.dataset.fornecedorEmail;
        
        solicitarPecaWhatsApp(codigo, nome, estoque, preco, fornecedorNome, fornecedorTelefone, fornecedorEmail);
        return;
    }
    
    const detalhesBtn = e.target.closest('.btn-detalhes');
    if (detalhesBtn) {
        const codigo = detalhesBtn.dataset.pecaCodigo;
        const nome = detalhesBtn.dataset.pecaNome;
        const compatibilidade = detalhesBtn.dataset.pecaCompatibilidade;
        const preco = detalhesBtn.dataset.pecaPreco;
        const estoque = detalhesBtn.dataset.pecaEstoque;
        const fornecedor = detalhesBtn.dataset.pecaFornecedor;
        
        // Preencher modal com dados
        document.getElementById('detalhe-codigo').textContent = codigo;
        document.getElementById('detalhe-nome').textContent = nome;
        document.getElementById('detalhe-preco').textContent = 'R$ ' + parseFloat(preco).toFixed(2);
        document.getElementById('detalhe-compatibilidade').textContent = compatibilidade || 'N√£o especificado';
        document.getElementById('detalhe-fornecedor').textContent = fornecedor;
        
        // Estoque com badge colorido
        const estoqueNum = parseInt(estoque);
        let badgeClass = 'bg-success';
        if (estoqueNum === 0) badgeClass = 'bg-danger';
        else if (estoqueNum < 5) badgeClass = 'bg-danger';
        else if (estoqueNum < 10) badgeClass = 'bg-warning';
        
        document.getElementById('detalhe-estoque-badge').innerHTML = 
            `<span class="badge ${badgeClass}">${estoqueNum} unidades</span>`;
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('detalhesPecaModal'));
        modal.show();
        return;
    }
    
    const editarBtn = e.target.closest('.btn-editar');
    if (editarBtn) {
        const id = editarBtn.dataset.pecaId;
        if (id !== undefined) {
            editarPeca(id);
        }
        return;
    }

    const excluirBtn = e.target.closest('.btn-excluir');
    if (excluirBtn) {
        const id = excluirBtn.dataset.pecaId;
        const nome = excluirBtn.dataset.pecaNome || '';
        if (id !== undefined) {
            excluirPeca(id, nome);
        }
        return;
    }
});

// Vari√°vel para controlar o estado do filtro
let filtroEstoqueBaixoAtivo = false;

// Filtrar pe√ßas com estoque baixo (< 6 unidades)
function filtrarEstoqueBaixo() {
    const rows = document.querySelectorAll('table.table tbody tr');
    const btn = document.getElementById('btnEstoqueBaixo');
    let contadorVisiveis = 0;
    
    filtroEstoqueBaixoAtivo = !filtroEstoqueBaixoAtivo;
    
    if (filtroEstoqueBaixoAtivo) {
        // Ativa o filtro - mostra apenas estoque baixo
        rows.forEach(row => {
            const estoqueTd = row.querySelector('td:nth-child(5)');
            if (estoqueTd) {
                const estoqueBadge = estoqueTd.querySelector('span.badge');
                if (estoqueBadge) {
                    const estoqueTexto = estoqueBadge.textContent.trim();
                    const estoqueNumero = parseInt(estoqueTexto.split(' ')[0]);
                    
                    console.log('Estoque encontrado:', estoqueTexto, '-> N√∫mero:', estoqueNumero);
                    
                    if (estoqueNumero < 6) {
                        row.style.display = '';
                        contadorVisiveis++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        });
        
        // Feedback visual no bot√£o
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-danger');
        btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Filtro Ativo (' + contadorVisiveis + ')';
        
        // Mostra notifica√ß√£o
        if (contadorVisiveis === 0) {
            alert('‚úÖ √ìtimas not√≠cias! Nenhuma pe√ßa com estoque baixo no momento.');
        }
        
    } else {
        // Desativa o filtro - mostra todas
        rows.forEach(row => {
            row.style.display = '';
            contadorVisiveis++;
        });
        
        // Restaura bot√£o original
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-warning');
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Estoque Baixo';
    }
    
    console.log(`Filtro Estoque Baixo: ${filtroEstoqueBaixoAtivo ? 'ATIVO' : 'INATIVO'} - ${contadorVisiveis} pe√ßas vis√≠veis`);
}

</script>
{% endblock %}