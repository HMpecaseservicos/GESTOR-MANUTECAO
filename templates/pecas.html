{% extends "base.html" %}

{% block title %}Pe√ßas{% endblock %}

{% block extra_css %}
<style>
/* ===== ESTILOS P√ÅGINA PE√áAS PROFISSIONAL ===== */

/* Header com gradiente */
.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 25px 30px;
    margin-bottom: 25px;
    color: white;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.page-header h1 {
    font-weight: 700;
    margin-bottom: 5px;
}

.page-header .breadcrumb {
    background: transparent;
    margin: 0;
    padding: 0;
}

.page-header .breadcrumb-item a {
    color: rgba(255,255,255,0.8);
}

.page-header .breadcrumb-item.active {
    color: white;
}

/* Stats Cards com anima√ß√£o */
.stats-card {
    border-radius: 15px;
    border: none;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.stats-card .card-body {
    padding: 20px;
}

.stats-card .stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 15px;
}

.stats-card .stats-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.stats-card .stats-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 5px;
}

/* Gradientes para cards */
.bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.bg-gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
.bg-gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.bg-gradient-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
.bg-gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

/* Barra de filtros */
.filter-bar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.filter-bar .form-control, 
.filter-bar .form-select {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    padding: 10px 15px;
}

.filter-bar .form-control:focus,
.filter-bar .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
}

/* Tabela moderna */
.table-container {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 2px 15px rgba(0,0,0,0.05);
}

.table-modern {
    margin: 0;
}

.table-modern thead {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.table-modern thead th {
    border: none;
    padding: 15px;
    font-weight: 600;
    color: #495057;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
}

.table-modern thead th:hover {
    background: #e9ecef;
}

.table-modern thead th i.sort-icon {
    margin-left: 5px;
    opacity: 0.3;
}

.table-modern thead th.sorted i.sort-icon {
    opacity: 1;
    color: #667eea;
}

.table-modern tbody tr {
    transition: all 0.2s;
    border-bottom: 1px solid #f1f3f5;
}

.table-modern tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
}

.table-modern tbody td {
    padding: 15px 12px;
    vertical-align: middle;
    font-size: 0.95rem;
}

/* Nome da pe√ßa mais vis√≠vel */
.table-modern tbody td strong {
    font-size: 1rem;
    color: #2d3748;
}

/* Pre√ßo formatado */
.preco-valor {
    font-size: 1.05rem;
    font-weight: 600;
    color: #38a169;
}

/* C√≥digo mais vis√≠vel */
.codigo-badge {
    font-size: 0.85rem;
    padding: 5px 10px;
    font-weight: 600;
}

/* Badges de categoria */
.badge-categoria {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.75rem;
}

/* Cards mobile */
.peca-card-mobile {
    display: none;
}

@media (max-width: 992px) {
    .table-container { display: none; }
    .peca-card-mobile { display: block; }
    
    .peca-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border-left: 4px solid #667eea;
    }
    
    .peca-card .peca-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }
    
    .peca-card .peca-title {
        font-weight: 600;
        font-size: 1rem;
        margin: 0;
    }
    
    .peca-card .peca-code {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .peca-card .peca-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
    }
    
    .peca-card .peca-info-item label {
        font-size: 0.75rem;
        color: #6c757d;
        display: block;
    }
    
    .peca-card .peca-info-item span {
        font-weight: 500;
    }
}

/* Modal categoria */
.categoria-color-picker {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.categoria-color-picker .color-option {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.categoria-color-picker .color-option:hover,
.categoria-color-picker .color-option.selected {
    transform: scale(1.1);
    border-color: white;
    box-shadow: 0 0 0 2px #667eea;
}

/* Confirma√ß√£o de exclus√£o */
.confirm-delete-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.confirm-delete-overlay.show {
    opacity: 1;
    visibility: visible;
}

.confirm-delete-box {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 400px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s;
}

.confirm-delete-overlay.show .confirm-delete-box {
    transform: scale(1);
}

.confirm-delete-box .delete-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 2rem;
    color: white;
}

/* Toast de feedback */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
}

.toast-custom {
    background: white;
    border-radius: 10px;
    padding: 15px 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast-custom.success { border-left: 4px solid #11998e; }
.toast-custom.error { border-left: 4px solid #ff416c; }
.toast-custom.warning { border-left: 4px solid #f5576c; }

/* Pagina√ß√£o */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 0 0 15px 15px;
}

.pagination-info {
    color: #6c757d;
    font-size: 0.875rem;
}

.pagination-controls .btn {
    border-radius: 8px;
    padding: 8px 15px;
}

/* Loading skeleton */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Bot√£o flutuante adicionar categoria */
.btn-float-category {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 100;
}

.btn-float-category:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
}
</style>
{% endblock %}

{% block content %}
<!-- Header da p√°gina -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li class="breadcrumb-item active">Pe√ßas</li>
                </ol>
            </nav>
            <h1><i class="fas fa-cogs"></i> Gest√£o de Pe√ßas</h1>
            <p class="mb-0 opacity-75">Controle completo do seu estoque de pe√ßas e componentes</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#novaPecaModal">
                <i class="fas fa-plus"></i> Nova Pe√ßa
            </button>
        </div>
    </div>
</div>

<!-- Cards de estat√≠sticas -->
<div class="row mb-4">
    <div class="col-md-3 col-6 mb-3">
        <div class="stats-card card">
            <div class="card-body">
                <div class="stats-icon bg-gradient-primary text-white">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="stats-value">{{ pecas|length }}</div>
                <div class="stats-label">Total de Pe√ßas</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stats-card card" onclick="filtrarStatus('disponivel')">
            <div class="card-body">
                <div class="stats-icon bg-gradient-success text-white">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-value">
                    {% set count = namespace(value=0) %}
                    {% for peca in pecas %}
                        {% if peca[6] >= 6 %}{% set count.value = count.value + 1 %}{% endif %}
                    {% endfor %}
                    {{ count.value }}
                </div>
                <div class="stats-label">Dispon√≠veis</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stats-card card" onclick="filtrarStatus('baixo')">
            <div class="card-body">
                <div class="stats-icon bg-gradient-warning text-white">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stats-value">
                    {% set count = namespace(value=0) %}
                    {% for peca in pecas %}
                        {% if peca[6] > 0 and peca[6] < 6 %}{% set count.value = count.value + 1 %}{% endif %}
                    {% endfor %}
                    {{ count.value }}
                </div>
                <div class="stats-label">Estoque Baixo</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stats-card card">
            <div class="card-body">
                <div class="stats-icon bg-gradient-info text-white">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stats-value">R$ {{ "{:,.2f}".format(valor_total_estoque)|replace(',', 'X')|replace('.', ',')|replace('X', '.') }}</div>
                <div class="stats-label">Valor em Estoque</div>
            </div>
        </div>
    </div>
</div>

<!-- Barra de filtros -->
<div class="filter-bar">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label small text-muted">Buscar</label>
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control" id="searchPecas" placeholder="Nome, c√≥digo ou compatibilidade...">
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted">Categoria</label>
            <select class="form-select" id="filterCategoria">
                <option value="">Todas</option>
                {% for cat in categorias %}
                <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted">Fornecedor</label>
            <select class="form-select" id="filterFornecedor">
                <option value="">Todos</option>
                {% for forn in fornecedores %}
                <option value="{{ forn[0] }}">{{ forn[1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted">Status</label>
            <select class="form-select" id="filterStatus">
                <option value="">Todos</option>
                <option value="disponivel">Dispon√≠vel</option>
                <option value="baixo">Estoque Baixo</option>
                <option value="zerado">Sem Estoque</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
    </div>
</div>

<!-- Tabela Desktop -->
<div class="table-container">
    <div class="table-responsive">
        <table class="table table-modern" id="tabelaPecas">
            <thead>
                <tr>
                    <th onclick="ordenarPor('codigo')">C√≥digo <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="ordenarPor('nome')">Nome <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="ordenarPor('categoria')">Categoria <i class="fas fa-sort sort-icon"></i></th>
                    <th>Compatibilidade</th>
                    <th onclick="ordenarPor('preco')">Pre√ßo <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="ordenarPor('estoque')">Estoque <i class="fas fa-sort sort-icon"></i></th>
                    <th>Fornecedor</th>
                    <th>Status</th>
                    <th style="width: 150px;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for peca in pecas %}
                <tr data-peca-id="{{ peca[0] }}" 
                    data-categoria="{{ peca[10] or '' }}" 
                    data-fornecedor="{{ peca[5] or '' }}"
                    data-status="{% if peca[6] == 0 %}zerado{% elif peca[6] < 6 %}baixo{% else %}disponivel{% endif %}">
                    <td>
                        <span class="badge bg-primary codigo-badge">{{ peca[2] }}</span>
                    </td>
                    <td>
                        <strong class="d-block">{{ peca[1] }}</strong>
                        {% if peca[3] %}<small class="text-muted">{{ peca[3] }}</small>{% endif %}
                    </td>
                    <td>
                        {% if peca[11] %}
                        <span class="badge badge-categoria" style="background-color: {{ peca[12] or '#6c757d' }}20; color: {{ peca[12] or '#6c757d' }};">
                            <i class="{{ peca[13] or 'fas fa-tag' }}"></i> {{ peca[11] }}
                        </span>
                        {% else %}
                        <span class="text-muted small">-</span>
                        {% endif %}
                    </td>
                    <td class="d-none d-lg-table-cell">
                        <small class="text-muted">{{ peca[3] or '-' }}</small>
                    </td>
                    <td>
                        <span class="preco-valor">R$ {{ "%.2f"|format(peca[4])|replace('.', ',') }}</span>
                    </td>
                    <td>
                        {% if peca[6] == 0 %}
                            <span class="badge bg-danger">{{ peca[6] }} un.</span>
                        {% elif peca[6] < 6 %}
                            <span class="badge bg-warning text-dark">{{ peca[6] }} un.</span>
                        {% else %}
                            <span class="badge bg-success">{{ peca[6] }} un.</span>
                        {% endif %}
                    </td>
                    <td>
                        <small>{{ peca[7] or '-' }}</small>
                    </td>
                    <td>
                        {% if peca[6] == 0 %}
                            <span class="badge bg-danger bg-opacity-10 text-danger">Sem Estoque</span>
                        {% elif peca[6] < 6 %}
                            <span class="badge bg-warning bg-opacity-10 text-warning">Baixo</span>
                        {% else %}
                            <span class="badge bg-success bg-opacity-10 text-success">OK</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-editar" title="Editar" data-peca-id="{{ peca[0] }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info btn-estoque" title="Ajustar Estoque" data-peca-id="{{ peca[0] }}" data-peca-nome="{{ peca[1] }}" data-peca-estoque="{{ peca[6] }}">
                                <i class="fas fa-boxes"></i>
                            </button>
                            {% if peca[6] < 6 and peca[8] %}
                            <button class="btn btn-outline-success btn-whatsapp" title="Solicitar via WhatsApp"
                                    data-peca-nome="{{ peca[1] }}"
                                    data-peca-codigo="{{ peca[2] }}"
                                    data-peca-estoque="{{ peca[6] }}"
                                    data-fornecedor-nome="{{ peca[7] or '' }}"
                                    data-fornecedor-telefone="{{ peca[8] or '' }}">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-danger btn-excluir" title="Excluir" data-peca-id="{{ peca[0] }}" data-peca-nome="{{ peca[1] }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma pe√ßa cadastrada ainda</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaPecaModal">
                            <i class="fas fa-plus"></i> Cadastrar primeira pe√ßa
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagina√ß√£o -->
    <div class="pagination-container" id="paginationContainer" style="display: none;">
        <div class="pagination-info">
            Mostrando <span id="paginationStart">1</span>-<span id="paginationEnd">10</span> de <span id="paginationTotal">{{ pecas|length }}</span> pe√ßas
        </div>
        <div class="pagination-controls">
            <button class="btn btn-outline-secondary btn-sm" id="btnPrevPage" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span class="mx-2">P√°gina <span id="currentPage">1</span></span>
            <button class="btn btn-outline-secondary btn-sm" id="btnNextPage">
                Pr√≥xima <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Cards Mobile -->
<div class="peca-card-mobile">
    {% for peca in pecas %}
    <div class="peca-card" data-peca-id="{{ peca[0] }}"
         data-categoria="{{ peca[10] or '' }}" 
         data-fornecedor="{{ peca[5] or '' }}"
         data-status="{% if peca[6] == 0 %}zerado{% elif peca[6] < 6 %}baixo{% else %}disponivel{% endif %}">
        <div class="peca-header">
            <div>
                <h6 class="peca-title">{{ peca[1] }}</h6>
                <span class="peca-code">{{ peca[2] }}</span>
            </div>
            {% if peca[6] == 0 %}
                <span class="badge bg-danger">Sem Estoque</span>
            {% elif peca[6] < 6 %}
                <span class="badge bg-warning text-dark">Baixo</span>
            {% else %}
                <span class="badge bg-success">OK</span>
            {% endif %}
        </div>
        <div class="peca-info">
            <div class="peca-info-item">
                <label>Categoria</label>
                <span>{{ peca[11] or 'Sem categoria' }}</span>
            </div>
            <div class="peca-info-item">
                <label>Estoque</label>
                <span>{{ peca[6] }} un.</span>
            </div>
            <div class="peca-info-item">
                <label>Pre√ßo</label>
                <span class="text-success">R$ {{ "%.2f"|format(peca[4]) }}</span>
            </div>
            <div class="peca-info-item">
                <label>Fornecedor</label>
                <span>{{ peca[7] or '-' }}</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-fill btn-editar" data-peca-id="{{ peca[0] }}">
                <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-sm btn-outline-danger btn-excluir" data-peca-id="{{ peca[0] }}" data-peca-nome="{{ peca[1] }}">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Bot√£o flutuante para gerenciar categorias -->
<button class="btn-float-category" data-bs-toggle="modal" data-bs-target="#gerenciarCategoriasModal" title="Gerenciar Categorias">
    <i class="fas fa-tags"></i>
</button>

<!-- Modal Nova Pe√ßa -->
<div class="modal fade" id="novaPecaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Nova Pe√ßa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novaPecaForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome da Pe√ßa *</label>
                            <input type="text" class="form-control" id="nome" name="nome" required placeholder="Ex: Filtro de √≥leo">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">C√≥digo *</label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required placeholder="Ex: FLT-001">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoria</label>
                            <div class="input-group">
                                <select class="form-select" id="categoria_id" name="categoria_id">
                                    <option value="">Selecione uma categoria</option>
                                    {% for cat in categorias %}
                                    <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#novaCategoriaModal" title="Nova Categoria">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fornecedor</label>
                            <select class="form-select" id="fornecedor_id" name="fornecedor_id">
                                <option value="">Selecione um fornecedor</option>
                                {% for forn in fornecedores %}
                                <option value="{{ forn[0] }}">{{ forn[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ve√≠culos/M√°quinas Compat√≠veis</label>
                        <input type="text" class="form-control" id="veiculo_compativel" name="veiculo_compativel" 
                               placeholder="Ex: Volvo FH, Mercedes Actros, Colheitadeira John Deere...">
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pre√ßo Unit√°rio *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="preco" name="preco" step="0.01" min="0" required placeholder="0,00">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantidade Inicial *</label>
                            <input type="number" class="form-control" id="quantidade_estoque" name="quantidade_estoque" min="0" required placeholder="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Estoque M√≠nimo</label>
                            <input type="number" class="form-control" id="estoque_minimo" name="estoque_minimo" min="0" value="5" placeholder="5">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="2" 
                                  placeholder="Informa√ß√µes adicionais sobre a pe√ßa..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarPeca()">
                    <i class="fas fa-save"></i> Salvar Pe√ßa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Pe√ßa -->
<div class="modal fade" id="editarPecaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Pe√ßa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editarPecaForm">
                    <input type="hidden" id="edit_peca_id">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome da Pe√ßa *</label>
                            <input type="text" class="form-control" id="edit_nome" name="nome" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">C√≥digo *</label>
                            <input type="text" class="form-control" id="edit_codigo" name="codigo" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="edit_categoria_id" name="categoria_id">
                                <option value="">Sem categoria</option>
                                {% for cat in categorias %}
                                <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fornecedor</label>
                            <select class="form-select" id="edit_fornecedor_id" name="fornecedor_id">
                                <option value="">Sem fornecedor</option>
                                {% for forn in fornecedores %}
                                <option value="{{ forn[0] }}">{{ forn[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ve√≠culos/M√°quinas Compat√≠veis</label>
                        <input type="text" class="form-control" id="edit_veiculo_compativel" name="veiculo_compativel">
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pre√ßo Unit√°rio *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="edit_preco" name="preco" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantidade em Estoque *</label>
                            <input type="number" class="form-control" id="edit_quantidade_estoque" name="quantidade_estoque" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Estoque M√≠nimo</label>
                            <input type="number" class="form-control" id="edit_estoque_minimo" name="estoque_minimo" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="atualizarPeca()">
                    <i class="fas fa-save"></i> Atualizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gerenciar Categorias -->
<div class="modal fade" id="gerenciarCategoriasModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-tags"></i> Gerenciar Categorias</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="listaCategorias" class="mb-3">
                    {% for cat in categorias %}
                    <div class="d-flex align-items-center justify-content-between p-2 mb-2 rounded" style="background: {{ cat[2] or '#6c757d' }}15;">
                        <div class="d-flex align-items-center gap-2">
                            <i class="{{ cat[3] or 'fas fa-tag' }}" style="color: {{ cat[2] or '#6c757d' }};"></i>
                            <span>{{ cat[1] }}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirCategoria({{ cat[0] }}, '{{ cat[1] }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhuma categoria cadastrada</p>
                    {% endfor %}
                </div>
                <hr>
                <h6><i class="fas fa-plus"></i> Nova Categoria</h6>
                <form id="novaCategoriaForm">
                    <div class="mb-3">
                        <label class="form-label">Nome da Categoria *</label>
                        <input type="text" class="form-control" id="cat_nome" placeholder="Ex: Pe√ßas Hidr√°ulicas, Pneus, Filtros...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cor</label>
                        <div class="categoria-color-picker">
                            <div class="color-option selected" style="background: #667eea;" data-color="#667eea"></div>
                            <div class="color-option" style="background: #11998e;" data-color="#11998e"></div>
                            <div class="color-option" style="background: #f5576c;" data-color="#f5576c"></div>
                            <div class="color-option" style="background: #f093fb;" data-color="#f093fb"></div>
                            <div class="color-option" style="background: #4facfe;" data-color="#4facfe"></div>
                            <div class="color-option" style="background: #fa709a;" data-color="#fa709a"></div>
                            <div class="color-option" style="background: #fee140;" data-color="#fee140"></div>
                            <div class="color-option" style="background: #6c757d;" data-color="#6c757d"></div>
                        </div>
                        <input type="hidden" id="cat_cor" value="#667eea">
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="criarCategoria()">
                        <i class="fas fa-plus"></i> Criar Categoria
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Categoria (r√°pido) -->
<div class="modal fade" id="novaCategoriaModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="fas fa-plus"></i> Nova Categoria</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="quick_cat_nome" placeholder="Nome da categoria">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" onclick="criarCategoriaRapida()">Criar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Estoque -->
<div class="modal fade" id="ajustarEstoqueModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-boxes"></i> Ajustar Estoque</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="estoque_peca_id">
                <p class="mb-2"><strong id="estoque_peca_nome"></strong></p>
                <p class="text-muted small">Estoque atual: <span id="estoque_atual" class="badge bg-secondary"></span></p>
                <div class="mb-3">
                    <label class="form-label">Tipo de Ajuste</label>
                    <select class="form-select" id="tipo_ajuste">
                        <option value="entrada">Entrada (adicionar)</option>
                        <option value="saida">Sa√≠da (remover)</option>
                        <option value="definir">Definir valor</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="qtd_ajuste" min="0" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="confirmarAjusteEstoque()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Overlay de confirma√ß√£o de exclus√£o -->
<div class="confirm-delete-overlay" id="confirmDeleteOverlay">
    <div class="confirm-delete-box">
        <div class="delete-icon">
            <i class="fas fa-trash"></i>
        </div>
        <h5>Excluir Pe√ßa?</h5>
        <p class="text-muted" id="deleteItemName">Esta a√ß√£o n√£o pode ser desfeita.</p>
        <input type="hidden" id="deletePecaId">
        <div class="d-flex gap-2 justify-content-center mt-4">
            <button class="btn btn-outline-secondary" onclick="fecharConfirmDelete()">Cancelar</button>
            <button class="btn btn-danger" onclick="confirmarExclusao()">
                <i class="fas fa-trash"></i> Excluir
            </button>
        </div>
    </div>
</div>

<!-- Container de toasts -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
// ===== VARI√ÅVEIS GLOBAIS =====
let pecasData = [];
let currentPage = 1;
const itemsPerPage = 15;
let currentSort = { column: null, direction: 'asc' };

// ===== INICIALIZA√á√ÉO =====
document.addEventListener('DOMContentLoaded', function() {
    // Configurar busca
    document.getElementById('searchPecas').addEventListener('input', debounce(filtrarPecas, 300));
    
    // Configurar filtros
    document.getElementById('filterCategoria').addEventListener('change', filtrarPecas);
    document.getElementById('filterFornecedor').addEventListener('change', filtrarPecas);
    document.getElementById('filterStatus').addEventListener('change', filtrarPecas);
    
    // Configurar seletor de cores
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('cat_cor').value = this.dataset.color;
        });
    });
    
    // Configurar bot√µes de a√ß√£o
    configurarBotoesAcao();
});

// ===== FUN√á√ïES DE UTILIDADE =====
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast-custom ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'times-circle text-danger' : 'exclamation-circle text-warning'}"></i>
        <span>${message}</span>
    `;
    container.appendChild(toast);
    
    setTimeout(() => toast.remove(), 4000);
}

// ===== FILTROS =====
function filtrarPecas() {
    const search = document.getElementById('searchPecas').value.toLowerCase();
    const categoria = document.getElementById('filterCategoria').value;
    const fornecedor = document.getElementById('filterFornecedor').value;
    const status = document.getElementById('filterStatus').value;
    
    // Filtrar tabela
    document.querySelectorAll('#tabelaPecas tbody tr[data-peca-id]').forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchSearch = !search || text.includes(search);
        const matchCategoria = !categoria || row.dataset.categoria == categoria;
        const matchFornecedor = !fornecedor || row.dataset.fornecedor == fornecedor;
        const matchStatus = !status || row.dataset.status === status;
        
        row.style.display = (matchSearch && matchCategoria && matchFornecedor && matchStatus) ? '' : 'none';
    });
    
    // Filtrar cards mobile
    document.querySelectorAll('.peca-card[data-peca-id]').forEach(card => {
        const text = card.textContent.toLowerCase();
        const matchSearch = !search || text.includes(search);
        const matchCategoria = !categoria || card.dataset.categoria == categoria;
        const matchFornecedor = !fornecedor || card.dataset.fornecedor == fornecedor;
        const matchStatus = !status || card.dataset.status === status;
        
        card.style.display = (matchSearch && matchCategoria && matchFornecedor && matchStatus) ? '' : 'none';
    });
}

function filtrarStatus(status) {
    document.getElementById('filterStatus').value = status;
    filtrarPecas();
}

function limparFiltros() {
    document.getElementById('searchPecas').value = '';
    document.getElementById('filterCategoria').value = '';
    document.getElementById('filterFornecedor').value = '';
    document.getElementById('filterStatus').value = '';
    filtrarPecas();
}

// ===== ORDENA√á√ÉO =====
function ordenarPor(coluna) {
    const table = document.getElementById('tabelaPecas');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-peca-id]'));
    
    // Determinar dire√ß√£o
    if (currentSort.column === coluna) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = coluna;
        currentSort.direction = 'asc';
    }
    
    // √çndices das colunas
    const colIndex = { codigo: 0, nome: 1, categoria: 2, preco: 4, estoque: 5 };
    const idx = colIndex[coluna];
    
    rows.sort((a, b) => {
        let valA = a.cells[idx].textContent.trim();
        let valB = b.cells[idx].textContent.trim();
        
        // Converter para n√∫mero se necess√°rio
        if (coluna === 'preco') {
            valA = parseFloat(valA.replace('R$', '').replace(',', '.')) || 0;
            valB = parseFloat(valB.replace('R$', '').replace(',', '.')) || 0;
        } else if (coluna === 'estoque') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
        }
        
        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Reordenar DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Atualizar √≠cones
    table.querySelectorAll('th').forEach(th => th.classList.remove('sorted'));
    event.target.closest('th').classList.add('sorted');
}

// ===== CRUD PE√áAS =====
function salvarPeca() {
    const form = document.getElementById('novaPecaForm');
    const formData = new FormData(form);
    
    fetch('/pecas/add', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Pe√ßa adicionada com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('novaPecaModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(err => showToast('Erro ao salvar pe√ßa', 'error'));
}

function configurarBotoesAcao() {
    // Bot√µes editar
    document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', function() {
            const pecaId = this.dataset.pecaId;
            // Carregar dados da pe√ßa para o modal de edi√ß√£o
            const row = document.querySelector(`tr[data-peca-id="${pecaId}"]`);
            if (row) {
                document.getElementById('edit_peca_id').value = pecaId;
                document.getElementById('edit_codigo').value = row.cells[0].textContent.trim();
                document.getElementById('edit_nome').value = row.cells[1].textContent.trim();
                document.getElementById('edit_categoria_id').value = row.dataset.categoria || '';
                document.getElementById('edit_veiculo_compativel').value = row.cells[3].textContent.trim();
                document.getElementById('edit_preco').value = row.cells[4].textContent.replace('R$', '').trim().replace(',', '.');
                document.getElementById('edit_quantidade_estoque').value = parseInt(row.cells[5].textContent) || 0;
                document.getElementById('edit_fornecedor_id').value = row.dataset.fornecedor || '';
                
                new bootstrap.Modal(document.getElementById('editarPecaModal')).show();
            }
        });
    });
    
    // Bot√µes estoque
    document.querySelectorAll('.btn-estoque').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('estoque_peca_id').value = this.dataset.pecaId;
            document.getElementById('estoque_peca_nome').textContent = this.dataset.pecaNome;
            document.getElementById('estoque_atual').textContent = this.dataset.pecaEstoque + ' un.';
            document.getElementById('qtd_ajuste').value = 1;
            
            new bootstrap.Modal(document.getElementById('ajustarEstoqueModal')).show();
        });
    });
    
    // Bot√µes excluir
    document.querySelectorAll('.btn-excluir').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('deletePecaId').value = this.dataset.pecaId;
            document.getElementById('deleteItemName').textContent = `Deseja excluir "${this.dataset.pecaNome}"? Esta a√ß√£o n√£o pode ser desfeita.`;
            document.getElementById('confirmDeleteOverlay').classList.add('show');
        });
    });
    
    // Bot√µes WhatsApp
    document.querySelectorAll('.btn-whatsapp').forEach(btn => {
        btn.addEventListener('click', function() {
            const nome = this.dataset.pecaNome;
            const codigo = this.dataset.pecaCodigo;
            const estoque = this.dataset.pecaEstoque;
            const fornecedor = this.dataset.fornecedorNome;
            const telefone = this.dataset.fornecedorTelefone;
            
            if (!telefone) {
                showToast('Fornecedor sem telefone cadastrado', 'warning');
                return;
            }
            
            // Limpar telefone (s√≥ n√∫meros)
            const telLimpo = telefone.replace(/\D/g, '');
            const telFormatado = telLimpo.startsWith('55') ? telLimpo : '55' + telLimpo;
            
            // Montar mensagem
            const msg = encodeURIComponent(
                `Ol√° ${fornecedor}!\\n\\n` +
                `Preciso solicitar reposi√ß√£o da pe√ßa:\\n` +
                `üì¶ *${nome}* (C√≥d: ${codigo})\\n` +
                `üìä Estoque atual: ${estoque} unidades\\n\\n` +
                `Poderia me enviar or√ßamento?\\n` +
                `Obrigado!`
            );
            
            window.open(`https://wa.me/${telFormatado}?text=${msg}`, '_blank');
        });
    });
}

function atualizarPeca() {
    const pecaId = document.getElementById('edit_peca_id').value;
    const form = document.getElementById('editarPecaForm');
    const formData = new FormData(form);
    
    fetch(`/pecas/edit/${pecaId}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Pe√ßa atualizada!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editarPecaModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    });
}

function fecharConfirmDelete() {
    document.getElementById('confirmDeleteOverlay').classList.remove('show');
}

function confirmarExclusao() {
    const pecaId = document.getElementById('deletePecaId').value;
    
    fetch(`/pecas/delete/${pecaId}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
        fecharConfirmDelete();
        if (data.success) {
            showToast('Pe√ßa exclu√≠da!', 'success');
            // Remover da DOM
            document.querySelector(`tr[data-peca-id="${pecaId}"]`)?.remove();
            document.querySelector(`.peca-card[data-peca-id="${pecaId}"]`)?.remove();
        } else {
            showToast(data.message, 'error');
        }
    });
}

function confirmarAjusteEstoque() {
    const pecaId = document.getElementById('estoque_peca_id').value;
    const tipo = document.getElementById('tipo_ajuste').value;
    const qtd = parseInt(document.getElementById('qtd_ajuste').value);
    
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('quantidade', qtd);
    
    fetch(`/pecas/estoque/${pecaId}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Estoque atualizado!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('ajustarEstoqueModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    });
}

// ===== CRUD CATEGORIAS =====
function criarCategoria() {
    const nome = document.getElementById('cat_nome').value.trim();
    const cor = document.getElementById('cat_cor').value;
    
    if (!nome) {
        showToast('Digite o nome da categoria', 'warning');
        return;
    }
    
    fetch('/api/categorias-pecas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, cor, icone: 'fas fa-tag' })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Categoria criada!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    });
}

function criarCategoriaRapida() {
    const nome = document.getElementById('quick_cat_nome').value.trim();
    
    if (!nome) {
        showToast('Digite o nome da categoria', 'warning');
        return;
    }
    
    fetch('/api/categorias-pecas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, cor: '#667eea', icone: 'fas fa-tag' })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Adicionar ao select
            const option = new Option(data.categoria.nome, data.categoria.id);
            document.getElementById('categoria_id').add(option);
            document.getElementById('categoria_id').value = data.categoria.id;
            
            bootstrap.Modal.getInstance(document.getElementById('novaCategoriaModal')).hide();
            showToast('Categoria criada!', 'success');
        } else {
            showToast(data.message, 'error');
        }
    });
}

function excluirCategoria(id, nome) {
    if (!confirm(`Excluir categoria "${nome}"?`)) return;
    
    fetch(`/api/categorias-pecas/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Categoria exclu√≠da!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    });
}
</script>
{% endblock %}
